# Управление авариями (Alarm Management)

## Обзор

Система управления авариями в ptusa_main реализована в соответствии с современными практиками SCADA систем и стандартом ISA-18.2 для промышленного управления тревогами.

## Основные возможности

### 1. Отслеживание временных меток (Timestamp Tracking)

Система автоматически записывает временные метки для ключевых событий жизненного цикла аварии:

- **alarm_time** - время возникновения тревоги
- **ack_time** - время подтверждения тревоги оператором
- **return_time** - время возврата в нормальное состояние

Эти метки позволяют:
- Анализировать скорость реакции операторов
- Определять длительность аварийных состояний
- Проводить статистический анализ аварий

### 2. Счетчик возникновений (Occurrence Counter)

Поле **occurrence_count** отслеживает количество раз, когда конкретная авария возникала с момента запуска системы.

Преимущества:
- Выявление повторяющихся проблем
- Приоритизация технического обслуживания
- Анализ надежности оборудования

### 3. Временное подавление аварий (Alarm Shelving)

Функция временного подавления позволяет временно отключить аварийные сообщения на заданный период времени.

#### Использование:

```cpp
// Подавить аварию на 3600 секунд (1 час).
G_ERRORS_MANAGER->set_cmd( base_error::C_CMD_SHELVE, 
                            device_type, 
                            device_number, 
                            3600 );

// Снять подавление до истечения времени.
G_ERRORS_MANAGER->set_cmd( base_error::C_CMD_UNSHELVE, 
                            device_type, 
                            device_number, 
                            alarm_number );
```

#### Применение:
- Плановое техническое обслуживание
- Известные временные проблемы
- Настройка и пуско-наладка

**Важно**: Временное подавление автоматически снимается по истечении заданного времени.

### 4. Состояния аварий

Система поддерживает следующие состояния аварий:

| Состояние | Описание |
|-----------|----------|
| AS_NORMAL | Нормальное состояние, аварии нет |
| AS_ALARM | Активная авария, требует внимания |
| AS_ACCEPT | Авария подтверждена оператором, но еще активна |
| AS_RETURN | Условия вернулись в норму, ожидается подтверждение |

### 5. Команды управления авариями

| Команда | Константа | Описание |
|---------|-----------|----------|
| Подтвердить | C_CMD_ACCEPT | Подтверждение аварии оператором |
| Подавить | C_CMD_SUPPRESS | Постоянное подавление аварии |
| Снять подавление | C_CMD_UNSET_SUPPRESS | Отмена постоянного подавления |
| Временное подавление | C_CMD_SHELVE | Временное подавление на N секунд |
| Снять временное подавление | C_CMD_UNSHELVE | Отмена временного подавления |

## Интеграция с Lua

Вся информация об авариях, включая новые поля, автоматически передается на сервер в формате Lua:

```lua
{
    description = "V1 - Ошибка обратной связи",
    priority = 250,
    state = 1,  -- AS_ALARM
    type = 4,   -- AT_SPECIAL
    group = "тревога",
    id_n = 1,
    id_object_alarm_number = -1,
    id_type = 1,
    suppress = false,
    alarm_time = 1706706000,
    occurrence_count = 3,
    shelved = false
}
```

## Примеры использования

### Пример 1: Подтверждение аварии

```cpp
// Получение списка аварий и подтверждение первой.
G_ERRORS_MANAGER->evaluate();

if ( G_ERRORS_MANAGER->get_errors_id() > 0 )
    {
    // Подтвердить аварию устройства типа 7, номер 0, номер аварии 1.
    G_ERRORS_MANAGER->set_cmd( base_error::C_CMD_ACCEPT, 7, 0, 1 );
    }
```

### Пример 2: Временное подавление перед обслуживанием

```cpp
// Запланировано обслуживание клапана V1 на 2 часа.
const int TWO_HOURS_IN_SECONDS = 7200;

G_ERRORS_MANAGER->set_cmd( 
    base_error::C_CMD_SHELVE, 
    device::DT_V,    // Тип устройства - клапан.
    1,               // Номер устройства.
    TWO_HOURS_IN_SECONDS 
);

// ... выполнение обслуживания ...

// После завершения можно снять подавление досрочно.
G_ERRORS_MANAGER->set_cmd( 
    base_error::C_CMD_UNSHELVE, 
    device::DT_V, 
    1, 
    1 
);
```

### Пример 3: Анализ истории аварий

Временные метки позволяют рассчитать важные метрики:

```cpp
// Длительность аварии (если она уже завершена).
time_t alarm_duration = return_time - alarm_time;

// Время реакции оператора.
time_t response_time = ack_time - alarm_time;

// Эти данные могут использоваться для:
// - KPI операторов
// - Анализа эффективности
// - Отчетности для менеджмента
```

## Рекомендации по использованию

1. **Своевременное подтверждение**: Операторы должны подтверждать аварии как можно скорее для точной статистики.

2. **Ограниченное использование временного подавления**: Используйте эту функцию только когда это действительно необходимо и документируйте причины.

3. **Мониторинг счетчика возникновений**: Регулярно проверяйте устройства с высоким счетчиком возникновений для планового обслуживания.

4. **Анализ временных метрик**: Используйте временные метки для улучшения процессов и обучения операторов.

## Технические детали

### Структура base_error

```cpp
class base_error
    {
    protected:
        unsigned char error_state;    // Состояние ошибки.
        time_t alarm_time;            // Время возникновения тревоги.
        time_t ack_time;              // Время подтверждения тревоги.
        time_t return_time;           // Время возврата в норму.
        u_int_4 occurrence_count;     // Количество возникновений тревоги.
        time_t shelve_time;           // Время установки временного подавления.
        u_int_4 shelve_duration;      // Длительность временного подавления, сек.
    };
```

### API для доступа к данным

```cpp
// Получение временных меток.
time_t get_alarm_time() const;
time_t get_ack_time() const;
time_t get_return_time() const;

// Получение счетчика возникновений.
u_int_4 get_occurrence_count() const;

// Проверка состояния временного подавления.
bool is_shelved() const;

// Управление временным подавлением.
void shelve_alarm( u_int_4 duration );
void unshelve_alarm();
```

## Совместимость

Все новые функции полностью совместимы с существующим кодом. Старые проекты продолжат работать без изменений, а новые возможности можно использовать по мере необходимости.

## См. также

- [Тестирование](../test/readme.md) - Информация о тестировании функций управления авариями
- [ISA-18.2 Standard](https://www.isa.org/standards-and-publications/isa-standards/isa-standards-committees/isa18) - Стандарт управления тревогами
- g_errors.h - Заголовочный файл с определениями
- g_errors.cpp - Реализация функций управления авариями
