/// @file PAC_dev.hh
/// @brief ������ � �������, ��������� � Lua.
///
/// @par ������� ������:
/// @$Rev$.\n
/// @$Author$.\n
/// @$Date::                     $.

$#include <stdlib.h>

$#include "PAC_dev.h"
$#include "tech_def.h"
$#include "cip_tech_def.h"
$#include "bus_coupler_io.h"
$#include "PID.h"
$#include "g_device.h"
$#include "g_errors.h"

$#include "rm_manager.h"
$#include "modbus_client.h"

$#include "modbus_serv.h"

$#include "profibus_slave.h"
$#ifdef WIN_OS
$#pragma warning(disable: 4800) //Warning C4800: 'int' : forcing value to bool 'true' or 'false' (performance warning)
$#pragma warning(disable: 6011)  //dereferencing NULL pointer <name>.
$#pragma warning(disable: 26812) //Prefer 'enum class' over 'enum'.
$#endif // WIN_OS

//-----------------------------------------------------------------------------
/// @brief ���������� �� ������ ����������� �����.
///
/// �������� �����, ���������� ������� � �.�. �������� ��������� �����
/// ���������.
class i_DI_device
    {
    public:
        /// @brief ��������� ���������������� ��������� ����������.
        ///
        /// ���������� ������ ���� ���������, ���� ���������� ���� ��������� �
        /// � ������ ��������� ������ ��������� ��������� �������.
        ///
        /// @return - ��������� ���������� � ���� ������ �����.
        int get_state();

        /// @brief ��������� ����������� ��������� ��������� ����������.
        bool is_active();
    };
//-----------------------------------------------------------------------------
/// @brief ���������� �� ������ ����������� ������.
///
/// ������, ������� � �.�. �������� ��������� ����� ���������.
class i_DO_device: public i_DI_device
    {
    public:
        /// @brief ��������� ����������.
        ///
        /// ��������� ���������� � �������� ���������. ��� ������� ��� ��������
        /// ��� �������������, �� ���� ���� �� ��������� �������� - ��������.
        void on();

        /// @brief ���������� ����������.
        ///
        /// ��������� ���������� � ��������� ���������. ��� ������� ��� ��������
        /// ��� ���������������, �� ���� ���� �� ��������� �������� - ��������.
        void off();

        /// @brief ����������� ���������� ����������
        ///
        /// ��������, ��� �������� �������������.
        void instant_off @ direct_off();

        /// @brief ����������� ���������� ���������� c ������ ������� ������
        void instant_off();

        /// @brief ��������� ������ ��������� ����������.
        ///
        /// @param new_state - ����� ��������� �������.
        void set_state( int new_state );
    };
//-----------------------------------------------------------------------------
/// @brief ���������� �� �� ������ ����������� �����.
///
/// �����������, ������ � �.�. �������� ��������� ����� ���������.
class i_AI_device
    {
    public:
        /// @brief ��������� �������� ��������� ����������.
        ///
        /// @return - ������� ��������� ���������� � ���� �������� �����.
        float get_value();
    };
//-----------------------------------------------------------------------------
/// @brief ���������� �� ������ ����������� ������.
///
/// ���������� ����� ���������� � �.�. �������� ��������� ����� ���������.
class i_AO_device: public i_AI_device
    {
    public:
        /// @brief ���������� ����������.
        ///
        /// ��������� ���������� � ��������� ���������. ��� ������� ��� ��������
        /// ��� ���������������, �� ���� ���� �� ��������� �������� - ��������.
        void off();

        /// @brief ��������� �������� ��������� ����������.
        ///
        /// @param new_value - ����� ��������� ����������.
        void set_value( float new_value );
    };
//-----------------------------------------------------------------------------
/// @brief ��������� ���������� ��� � �����������, ��� � ����������� ��������.
class i_DO_AO_device: public i_DO_device, public i_AO_device
    {
    public:
        /// @brief ��������� ���������������� ��������� ����������.
        ///
        /// ���������� ������ ���� ���������, ���� ���������� ���� ��������� �
        /// � ������ ��������� ������ ��������� ��������� �������.
        ///
        /// @return - ��������� ���������� � ���� ������ �����.
        int get_state();

        /// @brief ��������� ���������.
        ///
        /// ������ ����� ������������ ��� ������� ��������� ���������� �����
        /// ��� ���������.
        ///
        /// @param new_state - ����� ���������.
        void set_state( int new_state );

        /// @brief ��������� ����������.
        ///
        /// ��������� ���������� � �������� ���������. ��� ������� ��� ��������
        /// ��� �������������, �� ���� ���� �� ��������� �������� - ��������.
        void on();

        /// @brief ���������� ����������.
        ///
        /// ��������� ���������� � ��������� ���������. ��� ������� ��� ��������
        /// ��� ���������������, �� ���� ���� �� ��������� �������� - ��������.
        void off();

        /// @brief ��������� �������� ��������� ����������.
        ///
        /// @return - ������� ��������� ���������� � ���� �������� �����.
        float get_value();

          /// @brief ��������� �������� ��������� ����������.
        ///
        /// @param new_value - ����� ��������� ����������.
        void set_value( float new_value );
    };
//-----------------------------------------------------------------------------
/// @brief ��������� ��������.
class i_counter
    {
    public:
        /// @brief ������������ ������ ��������.
        void pause();

        /// @brief ������������� ������ ��������.
        void start();

        /// @brief ����� ��������.
        ///
        /// ����� ������ ��� ����������� ������ ���������� ������� @ref start().
        void reset();

        /// @brief ����� �������� � ����������� �����.
        void restart();

        /// @brief ��������� �������� �������� (�����).
        unsigned int get_quantity();

        /// @brief ��������� �������� �������� (�����).
        float get_flow();

        /// @brief ��������� ��������� ������ ��������.
        virtual int get_state();

        /// @brief ��������� ����������� �������� �������� (��� �����
        /// ��������� �����).
        unsigned int get_abs_quantity();

        /// @brief ����� ����������� �������� ��������.
        void abs_reset();
    };
//-----------------------------------------------------------------------------
/// @brief ������� ���������� ����������.
///
/// ������� ����� ���������: ������, �����, ������� � �.�.
class device : public i_DO_AO_device
    {
#pragma region ���������� ����������� �� ����������������� ������� Lua.
    public:
        /// @brief ���������� ���������� � ������ ������� ������.
        void off();

        /// @brief ��������� ���������� � ������ ������� ������.
        void on();

        /// @brief ��������� ������ ��������� ���������� � ������ ������� ������.
        ///
        /// @param new_state - ����� ��������� ����������.
        void set_state( int new_state );

        /// @brief ��������� �������� ��������� ����������.
        ///
        /// @return - ������� ��������� ���������� � ���� �������� �����.
        float get_value();

        /// @brief ��������� �������� ��������� ����������.
        ///
        /// @param new_value - ����� ��������� ����������.
        void set_value( float new_value );
#pragma endregion

    public:
        /// @brief ���������� ������� �����������.
        ///
        /// ��� ��������� ������, ���������� �� �������.
        int set_cmd( const char *prop, unsigned int idx, double val );

        void set_par( unsigned int idx, unsigned int offset, float value );

        /// @brief ��������� �������� �������� ���������.
        ///
        /// @param idx - ������ �������� ��������� (� �������).
        /// @param value - ����� ��������.
        virtual void set_rt_par( unsigned int idx, float value );

        void set_property( const char* field, device* dev );

        void set_string_property(const char* field, const char* value);

        void set_descr( const char *description );

        /// @brief ���������� ���������� � ������ ������� ������.
        void off();
        /// @brief ��������� ���������� � ������ ������� ������.
        virtual void on();
        /// @brief ��������� �������� ��������� ���������� � ������ ������� ������.
        virtual void set_value( float new_value );

        enum DEVICE_TYPE
            {
            DT_NONE = -1,///< ��� �� ���������.

            DT_V = 0,   ///< ������.
            DT_VC,      ///< ����������� ������.
            DT_M,       ///< ���������.
            DT_LS,      ///< ������� (����/���).
            DT_TE,      ///< �����������.
            DT_FS,      ///< ������ (����/���).
            DT_GS,      ///< ������ ���������.
            DT_FQT,     ///< �������.
            DT_LT,      ///< ������� (��������).
            DT_QT,      ///< ������������.

            DT_HA,      ///< ��������� �������� ������������.
            DT_HL,      ///< ��������� �������� ������������.
            DT_SB,      ///< ������.
            DT_DI,      ///< ���������� ������� ������.
            DT_DO,      ///< ���������� �������� ������.
            DT_AI,      ///< ���������� ������� ������.
            DT_AO,      ///< ���������� �������� ������.
            DT_WT,		///< �������������.
            DT_PT,      ///< �������� (��������).
            DT_F,       ///< �������������� �����������.
            };
    };
//-----------------------------------------------------------------------------
/// @brief ����
class i_wages
    {
    public:
        /// @brief ���������.
        ///
        /// @return - none.
        void tare();
        /// @brief ��������� �������� ��������� ����������.
        ///
        /// @return - ��� � ��.
        float get_value();
    };
//-----------------------------------------------------------------------------
/// @brief �����.
class i_motor : public device
    {
    public:
        void reverse();
    };
//-----------------------------------------------------------------------------
/// @brief ��������� ������� �� �����.
///
/// @param dev_name - ��� �������.
/// @return - ������ � �������� ������. ���� ��� ������ �������, ������������
/// �������� (@ref dev_stub).
valve* V( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ������������ ������� �� �����.
///
/// @param dev_name - ��� �������.
/// @return - ������ � �������� ������. ���� ��� ������ �������, ������������
/// �������� (@ref dev_stub).
i_AO_device* VC( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ��������� �� �����.
///
/// @param dev_name - ��� ���������.
/// @return - ��������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_motor* M( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ����������� ������ �� �����.
///
/// @param dev_name - ��� ����������� ������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_DI_device* LS( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ����������� ������� �� �����.
///
/// @param dev_name - ��� ����������� �������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_DI_device* FS( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ����������� ����� �� �����.
///
/// @param dev_name - ��� ����������� �����.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_AI_device* AI( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ����������� ������ �� �����.
///
/// @param dev_name - ��� ����������� ������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_AO_device* AO( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� �������� �� �����.
///
/// @param dev_name - ��� ��������.
/// @return - ���������� � �������� �������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_counter* FQT( const char *dev_name );

virtual_counter* virtual_FQT( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ����������� �� �����.
///
/// @param dev_name - ��� �����������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_AI_device* TE( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� �������� ������ �� �����.
///
/// @param dev_name - ��� �������� ������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
level* LT( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ������� ��������� �� �����.
///
/// @param dev_name - ��� ������� ���������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_DI_device* GS( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� �������� ������������ �� �����.
///
/// @param dev_name - ��� ��������� ������������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_DO_device* HA( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� �������� ������������ �� �����.
///
/// @param dev_name - ��� �������� ������������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_DO_device* HL( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ������ �� �����.
///
/// @param dev_name - ��� ������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_DI_device* SB( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� �������� ����� �� �����.
///
/// @param dev_name - ��� �������� �����.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_DI_device* DI( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ������ ���������� �� �����.
///
/// @param dev_name - ��� ������ ����������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_DO_device* DO( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ������� ������������ �� �����.
///
/// @param dev_name - ��� ������� ������������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_AI_device* QT( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ����� �� �����.
///
/// @param dev_name - ��� ������� �����.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_wages* WT( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� �������� �������� �� �����.
///
/// @param dev_name - ��� �������� ��������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_AI_device* PT( const char *dev_name );
//-----------------------------------------------------------------------------
/// @brief ��������� ��������������� ����������� �� �����.
///
/// @param number - ����� ��������������� �����������.
/// @return - ���������� � �������� ������. ���� ��� ������ ����������,
/// ������������ �������� (@ref dev_stub).
i_AO_device* F(const char* dev_name);
//-----------------------------------------------------------------------------
/// @brief ��������� ����������-��������.
///
/// @return - ����������� ����������.
dev_stub* STUB();

device* DEVICE( int s_number );
//-----------------------------------------------------------------------------
//-----------------------------------------------------------------------------
/// @brief ����������� ����������.
///
/// ���������� ��� ����������� ���������� ������ ���������� � ��������������
/// �������. ������ ������� ������ ������ �� ������.
class dev_stub
    {
    public:
        /// @brief ��������� ��������� ����������.
        ///
        /// @return 0
        float get_value();

        /// @brief ��������� ��������� ����������. ������ �� ������.
        void set_value( float new_value );


        /// @brief ��������� ����������. ������ �� ������.
        void on();

        /// @brief ���������� ����������. ������ �� ������.
        void off();


        /// @brief ��������� ��������� ����������. ������ �� ������.
        void set_state( int new_state );

        /// @brief ��������� ��������� ����������.
        ///
        /// @return 0
        int get_state();

        /// @brief ��������� ��������. ������ �� ������.
        void pause();

        /// @brief ������������� ��������. ������ �� ������.
        void start();

        /// @brief ����� ��������. ������ �� ������.
        void reset();

        /// @brief ��������� �������� ��������.
        ///
        /// @return 0
        unsigned int get_quantity();
    };
//-----------------------------------------------------------------------------
//-----------------------------------------------------------------------------
/// @brief �������� ���������� �� ���� ������� ������� ���������.
class errors_manager
    {
    public:
        /// @brief ��������� ������������� ���������� ������.
        static errors_manager* get_instance();

        /// @brief ��������� ���������� ������.
        void set_cmd( unsigned int cmd, unsigned int object_type,
            unsigned int object_number, unsigned int object_alarm_number );
    };

//������������� � ���������� ������� �������� EasyDrv. FIXME.
class dev_errors_manager
    {
    public:
        /// @brief ��������� ������������� ���������� ������.
        static errors_manager* get_instance();

        /// @brief ��������� ���������� ������.
        void set_cmd( unsigned int cmd, unsigned int object_type,
            unsigned int object_number, unsigned int object_alarm_number );
    };
//-----------------------------------------------------------------------------
//-----------------------------------------------------------------------------
/// @brief ��������� valve.
class valve
    {
    public:
        /// @brief ��������� �������� ����������� ���������.
        bool is_opened();

        /// @brief ��������� �������� ������������ ���������.
        bool is_closed();

        /// @brief ��������� ���������� � ������ ������� ������.
        virtual void on();

        /// @brief ���������� ���������� � ������ ������� ������.
        virtual void off();

        /// @brief ����������� ���������� ����������
        ///
        /// ��������, ��� �������� �������������.
        void instant_off @ direct_off();

        /// @brief ����������� ���������� ���������� c ������ ������� ������
        virtual void instant_off();

        /// @brief ��������� ������ ��������� ���������� � ������ ������� ������.
        ///
        /// @param new_state - ����� ��������� ����������.
        virtual void set_state( int new_state );

        /// @brief ��������� ��������� ����������.
        ///
        /// @return ��������� ���������� � ���� ������ �����.
        virtual int get_state();

    public:
        /// @brief ��������� �������� �������� ����� �� ���������� ���������.
        int get_on_fb_value();

        /// @brief ��������� �������� �������� ����� �� ����������� ���������.
        int get_off_fb_value();

    ///��������� ������� ��� ����� �������� �����.
    enum VALVE_STATE
        {
        V_LOWER_SEAT = 3, ///< ������� ������ �����.
        V_UPPER_SEAT = 2, ///< ������� ������� �����.

        V_ON  = 1,        ///< �������.
        V_OFF = 0,        ///< ��������.
        };
    };
//-----------------------------------------------------------------------------
/// @brief ��������� �������� �������.
class level : public i_AI_device
    {
    public:
        virtual float get_volume();
    };
//-----------------------------------------------------------------------------
/// @brief ����������� ���������� ��� �������� � ������� �����-������
class virtual_counter : public device
    {
    public:
        /// @brief ����� ��������.
        void reset();

        /// @brief ��������� �������� �������� (�����).
        unsigned int get_quantity();

        /// @brief ��������� �������� �������� (�����).
        float get_flow();

        /// @brief ��������� ��������� ������ ��������.
        virtual int get_state();

        /// @brief ��������� ����������� �������� �������� (��� �����
        /// ��������� �����).
        unsigned int get_abs_quantity();

        /// @brief ����� ����������� �������� ��������.
        void abs_reset();

        void set( unsigned int value, unsigned int abs_value, float flow );

        void eval( unsigned int read_value, unsigned int abs_read_value,
            float read_flow );
    };
//-----------------------------------------------------------------------------
//-----------------------------------------------------------------------------
/// @brief ������ � ��������������� ��������.
///
/// ������� ����� ��� ���������������� ������� (�����, ��������). ��������
/// �������� ������ ������ - ������ � �������� � �.�.
class tech_object
    {
    public:
        int set_cmd( const char *prop, unsigned int idx, double val );

        /// @param name                     - �������� ("��������", ...).
        /// @param number                   - �����.
        /// @param type                     - ���.
        /// @param name_Lua                 - ��� � Lua.
        /// @param states_count             - ���������� �������.
        /// @param timers_count             - ���������� ��������.
        /// @param par_float_count          - ���������� ����������� ���������� ���� float.
        /// @param runtime_par_float_count  - ���������� ������� ���������� ���� float.
        /// @param par_uint_count           - ���������� ����������� ���������� ���� uint.
        /// @param runtime_par_uint_count   - ���������� ������� ���������� ���� uint.
        tech_object( const char* name, unsigned int number, unsigned int type,
            const char* name_Lua,
            unsigned int  states_count,
            unsigned int  timers_count,
            unsigned int  par_float_count, unsigned int  runtime_par_float_count,
            unsigned int  par_uint_count, unsigned int runtime_par_uint_count );

        ~tech_object();

        /// @brief ���������/���������� ������.
        ///
        /// @param mode      - �����.
        /// @param new_state - ����� ��������� ������. ��������� ��������: 0 -
        /// ���������, 1 - ��������, -1 - ��������� ��� �������� �� �����������
        ///	����������.
        int set_mode( unsigned int mode, int new_state );

        /// @brief ��������� ��������� ������.
        ///
        /// @param mode - �����.
        ///
        /// @return 1 - ����� �������.
        /// @return 0 - ����� �� �������.
        int get_mode( unsigned int mode );

        /// @brief ��������� ��������� ������.
        ///
        /// @param mode - �����.
        ///
        /// @return ... - ����� � ...
        /// @return 2 - ����� � �����.
        /// @return 1 - ����� �������.
        /// @return 0 - ����� �� �������.
        int get_operation_state( unsigned int mode );

        /// @brief ���������� �������.
        ///
        /// ����� ����� ����������� �����-���� �������� (����������/�����������
        /// ������ ������, ����������/����������� �����-���� ����������).
        int exec_cmd( unsigned int cmd );

        /// @brief ��������� ����� ������� ���������������� �������.
        ///
        /// ����� ����� ����������� �����-���� �������� (����������/�����������
        /// ������ ������, ����������/����������� �����-���� ����������).
        unsigned int get_modes_count() const;

        int check_operation_on( unsigned int operation_n, bool show_error = true);

        saved_params_float      par_float;   ///< ����������� ���-��, ��� float.
        run_time_params_float   rt_par_float;///< ������� ���������, ��� float.
        saved_params_u_int_4    par_uint;    ///< ����������� ���-��, ��� uint.
        run_time_params_u_int_4 rt_par_uint; ///< ������� ���-��, ��� uint.

        timer_manager           timers;		 ///< ������� �������.

        operation_manager* get_modes_manager();

        /// @brief ������ ���������� ������������� �������.
        ///
        bool is_idle() const;

        int get_number() const;

        enum ERR_MSG_TYPES
            {
            ERR_CANT_ON,
            ERR_ON_WITH_ERRORS,
            ERR_OFF,
            ERR_OFF_AND_ON,
            ERR_DURING_WORK,
            ERR_ALARM,

            ERR_TO_FAIL_STATE,
            ERR_CANT_ON_2_OPER, //��� �������� ����������� ��������.
            ERR_CANT_ON_2_OBJ,  //��� �������� ����������� �������� ������� �������.
            };

        int set_err_msg( const char *err_msg, int mode, int new_mode = 0,
            ERR_MSG_TYPES type = ERR_CANT_ON );
    };
//-----------------------------------------------------------------------------
///@brief ��������� ��������� ��������������� ��������.
///
///@return �������� ��������������� �������� �������.
tech_object_manager* G_TECH_OBJECT_MNGR();
//-----------------------------------------------------------------------------
/// @brief �������� ��������������� ��������.
///
/// �������� ���������� ��� ���� ��������������� �������� �������.
class tech_object_manager
    {
    public:
        /// @brief ��������� ������� � �������� �������� �������.
        int get_object_with_active_mode( unsigned int mode,
            unsigned int start_idx, unsigned int end_idx );

        /// @brief ��������� ���������������� ������� �� ��� ����������� ������.
        tech_object* get_tech_objects( unsigned int idx );

        /// @brief ���������� ������ �������.
        void print();
    };
//-----------------------------------------------------------------------------
//-----------------------------------------------------------------------------
/// @brief �������� ���������� �� ��������.
///
/// �������� ����� ���������� � ����� �� ���������.
class operation
    {
    public:
        enum state_idx
            {
            RUN = 1,// ����������
            PAUSE,  // �����
            STOP,   // ����������
            };

    public:
        unsigned long evaluation_time();

        unsigned int active_step() const;

        unsigned long active_step_evaluation_time() const;
        unsigned long get_active_step_set_time() const;

        /// @brief ������� � ��������� ����.
        ///
        /// @param new_step - ����� ���� (� �������).
        /// @param cooperative_time - ����� ���������� ������ (���).
        void to_step( unsigned int new_step, unsigned long cooperative_time = 0 );

        /// @brief ������� � ���������� ����.
        ///
        /// ������ ����� �������� ����������, ����� ���������� ������������
        /// ������� to_step, ��������� � �������� ��������� ����� �������� ����,
        /// ������������ �� �������.
        void to_next_step();

        /// @brief ��������� ������ ����� �������� ��������������.
        ///
        /// @param idx - ������ ������.
        ///
        /// @return - �������� ������ � �������� ��������. ���� ������
        /// ������� �� ��������, ������������ �������� �������� - ����
        /// mode_stub.
        operation_state* operator[]( int idx );

    public:
        /// @brief ��������� ��������� ����.
        ///
        /// @param step - ����� ����������� ���� (� �������).
        int on_extra_step( int step );

        /// @brief ���������� ��������� ����.
        ///
        /// @param step - ����� ������������ ���� (� �������).
        int off_extra_step( int step );

        /// @brief ���������� ��������� ��������� ���� � ��������� �������.
        ///
        /// @param off_step - ����� ������������ ���� (� �������).
        /// @param on_step - ����� ����������� ���� (� �������).
        int switch_active_extra_step( int off_step, int on_step );

        /// @brief ����������� ���������� ��������� ����.
        ///
        /// @param step_idx - ����� ������������ ���� (� �������).
        bool is_active_extra_step( int step_idx ) const;

    public:
        step* add_step( const char* name, int next_step_n,
            unsigned int step_duration_par_n, state_idx s_idx = RUN );

    public:

        state_idx get_state() const;
    };
//-----------------------------------------------------------------------------
/// @brief �������� ���������� � ���� ��������� ������-���� ������� (����,
/// ����� � �.�.).
///
/// � ������� (����, ...) �������� ���������� �������������, �������� � �.�.
class operation_manager
    {
    public:
        operation* add_mode( const char* name );
        operation* add_operation( const char* name );

        /// @brief ��������� ������ ����� �������� ��������������.
        ///
        /// @param idx - ������ ������.
        ///
        /// @return - �������� ������ � �������� ��������. ���� ������
        /// ������� �� ��������, ������������ �������� �������� - ����
        /// mode_stub.
        operation* operator[] ( unsigned int idx );

        /// @brief ����� ����������� (��� ���������� ��������).
        ///
        /// @return - ����� ������� ��� �������� ��������.
        unsigned long get_idle_time();
    };
//-----------------------------------------------------------------------------
/// @brief ��������� ��������.
///
/// �������� ������ �����, ����������� ��������������� (��� � ���� �������).
class operation_state
    {
    public:
        /// @brief ��������� �������� ����� �������� ��������������.
        ///
        /// @param idx - ������ ��������.
        ///
        /// @return - �������� �������� � �������� ��������. ���� ������
        /// ������� �� ��������, ������������ �������� �������� - ���� @ref
        /// mode::step_stub.
        step* operator[] ( int idx );
    };
//-----------------------------------------------------------------------------
/// @brief �������� ���������� �� �����������, ������� ������ � ��� (�����������/
/// �����������).
///
/// � ������ ����� ���� �������� (�����������) ������ ���� ���.
class step
    {
    public:
        /// @brief ��������� �������� ����� �������� ��������������.
        ///
        /// @param index - ������ ��������.
        ///
        /// @return - �������� �������� � �������� ��������. ���� ������
        /// ������� �� ��������, ������������ �������� 0.
        action* operator[] ( int idx );

        const char* get_name() const;

        enum ACTIONS
            {
            A_ON = 0,
            A_ON_REVERSE,
            A_OFF,
            A_UPPER_SEATS_ON,
            A_LOWER_SEATS_ON = A_UPPER_SEATS_ON,

            A_REQUIRED_FB,
            A_DI_DO,
            A_AI_AO,
            A_WASH,
            };

        bool is_active() const;
    };
//-----------------------------------------------------------------------------
/// @brief �������� ��� ������������ (���������, ���������� � �.�.).
class action
    {
    public:
        /// @brief ���������� ���������� � ��������.
        ///
        /// @param [in] dev ����������.
        /// @param [in] group �������������� ��������.
        /// @param [in] subgroup �������������� ��������.
        virtual void add_dev( device *dev, unsigned int group,
            unsigned int subgroup );

        /// @brief ������� �������� ������������ ���������� � ��������.
        ///
        /// @param [in] position ������� ���������.
        /// @param [in] idx ������ ���������.
        void set_param_idx( unsigned int position, int idx );
    };
//-----------------------------------------------------------------------------
///@brief ��������� ��������� ���������.
///
///@return �������� ��������� �������.
device_manager* G_DEVICE_MANAGER();

///@brief ��������� ���������������� ������� �� ������.
///
///@return ��������������� ������.
tech_object* G_TECH_OBJECTS( unsigned int idx );
//-----------------------------------------------------------------------------
/// @brief �������� ���������.
///
/// �������� ���������� ��� ���� ����������� �������.
class device_manager
    {
    public:
        /// @brief ���������� ������ ������� � �������.
        void print() const;

        // @brief ��������� ����� ���������.
        //
        // ���������� �� Lua.
        io_device* add_io_device( int dev_type, int dev_sub_type,
            const char *dev_name, char * descr, char* article );

        /// @brief ��������� ���������� �� ��� ������.
        device* get_device( int dev_type,
            const char *dev_name );
    };
//-----------------------------------------------------------------------------
/// @brief ���������� �� ������ ������� �����/������.
///
/// � ����� ������ � ���������� ����� ���� ���� ��� ��������� �������
/// �����/������ (���������� ��� ����������).
class io_device
    {
    public:
        // Lua.
        enum VENDOR
            {
            WAGO,
            PHOENIX,
            };

        void init( int DO_count, int DI_count,
            int AO_count, int AI_count );

        void init_channel( int type, int ch_inex, int node, int offset, int module_offset = -1, int logical_port = -1 );

        void set_io_vendor( VENDOR vendor );
    };
//-----------------------------------------------------------------------------
/// @brief ������ ��������.
class timer_manager
    {
    public:
        /// @brief ���������� ��������� ������� �� �������.
        ///
        /// @param index - ������ �������.
        ///
        /// @return - ������ � ������ ��������, �������� - � ������ ������ ��
        /// ��������.
        timer* operator[] ( unsigned int index );
    };
//-----------------------------------------------------------------------------
/// @brief ������.
class timer
    {
    public:
        /// @brief ��������� �������.
        enum STATE
            {
            S_STOP = 0, ///< �� ��������.
            S_WORK,     ///< ��������.
            S_PAUSE,    ///< �����.
            };

        /// @brief ������ �������.
        void start();

        /// @brief ����� �������.
        void reset();

        /// @brief ����� �������.
        void pause();

        /// @brief �������� ������ ������� �������.
        ///
        /// @return true  - ����� �����.
        /// @return false - ����� �� �����.
        bool is_time_up() const;

        /// @brief ��������� ������� ������ �������.
        ///
        /// @return - ����� ������ �������.
        unsigned long  get_work_time() const;

        /// @brief ��������� ������� �������.
        ///
        /// @param new_countdown_time - �������.
        void set_countdown_time( unsigned long new_countdown_time );

        /// @brief ��������� ������� �������.
        ///
        /// @return - ������� �������.
        unsigned long  get_countdown_time() const;

        /// @brief ��������� ��������� �������.
        ///
        /// @return - ��������� �������.
        STATE get_state() const;

        timer();
    };
//-----------------------------------------------------------------------------
/// @brief ������ � ������������ ����������� ���� "������� �����".
///
/// ��������� ����������� � ����������������� ������.
class saved_params_float
    {
    public:
        /// @brief ���������� �������� @a value � �������� � ������� @a idx
        /// � ����������������� ������.
        ///
        /// @param idx   - ������ ���������.
        /// @param value - �������� ���������.
        int save( unsigned int idx, float value );

        /// @brief ���������� ���� ���������� � ����������������� ������.
        int save_all();

        /// @brief ��������� ��������� �� ��� ������.
        ///
        /// ��� ������������ ��������� ������ �������� (�������� par[ 5 ] = 6),
        /// �������� ����������� ������ � ����������� ������ (�� ��������
        ///	�������� ����� ������������ �����������).
        ///
        /// @param idx   - ������ ���������.
        ///
        /// @return - �������� c �������� ��������.
        float& operator[] ( unsigned int idx );

        /// @brief ��������� ���� ���������� � ������� �������� � ����������
        /// � ����������������� ������.
        void reset_to_0();
    };
//-----------------------------------------------------------------------------
/// @brief ������ � ������������ ����������� ���� "����������� ����� �����".
///
/// ��������� ����������� � ����������������� ������.
class saved_params_u_int_4
    {
    public:
        /// @brief ���������� �������� @a value � �������� � ������� @a idx
        /// � ����������������� ������.
        int save( unsigned int idx, unsigned int value );

        /// @brief ���������� ���� ���������� � ����������������� ������.
        int save_all();

        /// @brief ��������� ��������� �� ��� ������.
        ///
        /// ��� ������������ ��������� ������ �������� (�������� par[ 5 ] = 6),
        /// �������� ����������� ������ � ����������� ������ (�� ��������
        ///	�������� ����� ������������ �����������).
        ///
        /// @param idx   - ������ ���������.
        ///
        /// @return - �������� c �������� ��������.
        unsigned int& operator[] ( unsigned int idx );

        /// @brief ��������� ���� ���������� � ������� �������� � ����������
        /// � ����������������� ������.
        void reset_to_0();
    };
//-----------------------------------------------------------------------------
/// @brief ������ � �������� ����������� ���� "����������� ����� �����".
///
/// ��������� ����������� � ����������� ������.
class run_time_params_u_int_4
    {
    public:
        /// @brief ��������� ��������� �� ��� ������.
        ///
        /// @param idx - ������ ���������.
        ///
        /// @return - �������� c �������� ��������.
        unsigned int& operator[] ( unsigned int idx );

        /// @brief ��������� ���� ���������� � ������� ��������.
        void reset_to_0();
    };
//-----------------------------------------------------------------------------
/// @brief ������ � �������� ����������� ���� "������� �����".
///
/// ��������� ����������� � ����������� ������.
class run_time_params_float
    {
    public:
        /// @brief ��������� ��������� �� ��� ������.
        ///
        /// @param idx - ������ ���������.
        ///
        /// @return - �������� c �������� ��������.
        float& operator[] ( unsigned int idx );

        /// @brief ��������� ���� ���������� � ������� ��������.
        void reset_to_0();
    };
//-----------------------------------------------------------------------------
/// @brief ������ � �������� �����/������.
///
/// ���������� ������ � ������ ��������� ������� �����/������.
class io_manager
    {
    public:
        /// @brief ��������� ����� �������.
        ///
        /// ���������� �� Lua.
        void init( int nodes_count );

        /// @brief ������������� ������.
        ///
        /// ���������� �� Lua.
        void add_node(  unsigned int index, int ntype, int address,
            char* IP_address, char *name, int DO_cnt, int DI_cnt, int AO_cnt, int AO_size,
            int AI_cnt, int AI_size );

        /// @brief ������������� ���������� ������ ����������� ������.
        ///
        /// ���������� �� Lua.
        void init_node_AO( unsigned int node_index, unsigned int AO_index,
            unsigned int type, unsigned int offset );

        /// @brief ������������� ���������� ������ ����������� �����.
        ///
        /// ���������� �� Lua.
        void init_node_AI( unsigned int node_index, unsigned int AI_index,
            unsigned int type, unsigned int offset );

    };
//-----------------------------------------------------------------------------
///@brief ��������� ���������.
///
///@return �������� ��������� �������.
io_manager* G_IO_MANAGER();
//-----------------------------------------------------------------------------
///@brief ���-���������.
///
///
class PID
    {
    public:

        ///@brief �������� ����������� ���������.
        enum PARAM
        {
        P_k = 1,               ///< �������� k.
        P_Ti,                  ///< �������� Ti.
        P_Td,                  ///< �������� Td.
        P_dt,                  ///< �������� �������
        P_max,                 ///< �ax �������� ������� ��������.
        P_min,                 ///< �in �������� ������� ��������.
        P_acceleration_time,   ///< ����� ������ �� ����� �������������.
        P_is_manual_mode,      ///< ������ �����.
        P_U_manual,            ///< �������� ������ �������� ��������� �������.

        P_k2,                  ///< �������� k2.
        P_Ti2,                 ///< �������� Ti2.
        P_Td2,                 ///< �������� Td2.

        P_out_max,             ///< �ax �������� �������� ��������.
        P_out_min,             ///< �in �������� �������� ��������.
        };

        ///@brief ������� ���������.
        enum WORK_PARAM
        {
        WP_Z = 1,  ///< ��������� ��������.
        WP_U,      ///< ����� ���.
        };

        /// @param n - �����.
        PID( int n );

        ///@brief ��������� ����������.
        void  on( char is_down_to_inaccel_mode = 0 );

        ///@brief ���������� ����������.
        void  off();

        /// @brief ����� ���
        void reset();

        ///@brief ��������� ���������� �������� ������ �� ������ ��������
        /// �������� �����.
        float eval( float current_value, int delta_sign = 1 );

        ///@brief ������� ����� ������� ���.
        void  set( float new_z );

        /// @brief ��������� ������� ���.
        float get_assignment();

        /// @brief ������ ������������ ���������.
        void init_param( PARAM par_n, float val );

        /// @brief ������ �������� ���������.
        void init_work_param( WORK_PARAM par_n, float val );

        /// @brief ������ ����������� ���������� � EEPROM.
        void save_param();

        /// @brief ������� ��� ������������� �������������� P_k2, P_Ti2, P_Td2.
        void  set_used_par ( int par_n );

        /// @brief ���������� ������ ������� � �������.
        void print();

        /// @brief ��������� ����������.
        unsigned int get_state();

        int set_cmd( const char *prop, unsigned int idx, double val );
    };
//-----------------------------------------------------------------------------
class PAC_info: public i_Lua_save_device
    {
    public:
        enum PARAMETERS
            {
            P_MIX_FLIP_PERIOD = 1, ///< �������� �������� ����� ��������, ���.
            P_MIX_FLIP_UPPER_TIME, ///< ����� �������� ������� ����� ��������, ����.
            P_MIX_FLIP_LOWER_TIME, ///< ����� �������� ������ ����� ��������, ����

            P_V_OFF_DELAY_TIME,    ///< ����� �������� �������� ��������, ����.

            ///< ����� �������� �������� ��� ������ ��������, ����.
            P_V_BOTTOM_OFF_DELAY_TIME,

            ///< ������� ����� �������� ��������� ������ �� ����, ����.
            P_WAGO_TCP_NODE_WARN_ANSWER_AVG_TIME,
            ///< ������� ����� ����� ���������, ����.
            P_MAIN_CYCLE_WARN_ANSWER_AVG_TIME,

            ///< ������ ������ �����������.
            /// 0 - ����, 1 - ������, 2 - ���������� (����� �����
            /// @P_RESTRICTIONS_MANUAL_TIME �������� � �������������� �����).
            P_RESTRICTIONS_MODE,

            ///< ������ ������ ����������� � ������ ������ �������� �����.
            P_RESTRICTIONS_MANUAL_TIME,

            ///< ������� �� ����� �������� ��� ������ ���������,
            /// 0 - ���� (����), 1 - ������ (���).
            P_AUTO_PAUSE_OPER_ON_DEV_ERR,
            };

        saved_params_u_int_4 par;

        int set_cmd( const char *prop, unsigned int idx, double val );
        bool is_emulator();
    };
//----------------------------------------------------------------------------
class siren_lights_manager
    {
    public:
        int init( device *red, device *yellow, device *green, device *srn );

        /// @brief ������� ���� ������� ��� ������� ��������.
        ///
        /// @param type - 0 - ��������� ����, 1 - ���������� � ������.
        void set_red_blink( int type );
    };
//-----------------------------------------------------------------------------
siren_lights_manager* G_SIREN_LIGHTS_MANAGER();
//----------------------------------------------------------------------------
PAC_info* G_PAC_INFO();
//-----------------------------------------------------------------------------
/// @brief ��������� �������� ������� � ��������.
///
/// @return ������� �����.
/// @warning ����� ������������ � �������� � 01.01.1970, � 2038 ����������
/// ������������.
unsigned long get_sec();
//-----------------------------------------------------------------------------
/// @brief ��������� ������� � �������������.
///
/// ��� ��� �� 4 ��� ���������� ������������ � ������ ������������ � 0, �� ���
/// ���������� �������� ������� ������������ @ref get_delta_millisec.
///
/// @return ����� � ������� ������� ��������� � �������������.
unsigned long get_millisec();
//-----------------------------------------------------------------------------
/// @brief ��������� �������� ������� � �������������.
///
/// @param time1     - ��������� �����.
/// @return �������� ������� � �������������.
unsigned long get_delta_millisec( unsigned long time1 );
//-----------------------------------------------------------------------------
/// @brief �������� �������� �����.
///
/// @param ms - ����� ��������, ��.
void sleep_ms( unsigned long ms );
//-----------------------------------------------------------------------------
/// @brief ���������, ����������� ������� ���� � �����.
struct tm {
    int tm_sec;     /// Seconds after the minute - [0,59].
    int tm_min;     /// Minutes after the hour - [0,59].
    int tm_hour;    /// Hours since midnight - [0,23].
    int tm_mday;    /// Day of the month - [1,31].
    int tm_mon;     /// Months since January - [0,11].
    int tm_year;    /// Years since 1900.
    int tm_wday;    /// Days since Sunday - [0,6].
    int tm_yday;    /// Days since January 1 - [0,365].
    int tm_isdst;   /// Daylight savings time flag.
    };
//-----------------------------------------------------------------------------
/// @brief ��������� ������� ���������� � �������.
///
/// @return ������� ���� � �����.
tm get_time();
////-----------------------------------------------------------------------------
/// @brief ����� ���������� ��� ������� �������
class MSAPID
    {
    public:
        void eval();
        void eval(float inputvalue, float task);
        void reset();
        void on( int accel = 0 );
        void off();
        void set( float new_z );
        int get_state();
    };
//
/// @brief ����� ��� ������ ������� �������
class cipline_tech_object: public tech_object
    {
    public:
        cipline_tech_object( const char* name, unsigned int number, unsigned int type, const char* name_Lua,
            unsigned int states_count,
            unsigned int timers_count,
            unsigned int par_float_count, unsigned int runtime_par_float_count,
            unsigned int par_uint_count, unsigned int runtime_par_uint_count );

        int blocked;
        int opcip;
        int curstep;
        int state;
        int curprg;
        int loadedRecipe;
        int loadedProgram;
        int nmr;

        bool nplaststate;   //��������� ��������� ��������� ������.
        bool pidf_override; //���������� ���-����������� ������ ������ �� �������.
        int cip_in_error;
        char no_neutro; ///���� ���������� �������������
        char dont_use_water_tank; //���� ����������� ������������� ����� ��������� ���� ��� �����
        int disable_tank_heating; //���������� ��������� ��� ������ ������ ��������� � ����(��� ��� �� ������� ������������� ���������)
        int ret_overrride; //���� ��������������� ���������/���������� ����������� �������
        int return_ok; //���� ������ �� ��������
        int concentration_ok; //���� ������������ �� ��������
        int enable_ret_pump; //������������ ��� ����, ����� ����������, ����� �� ��������� ���������� �����
        int clean_water_rinsing_return; //���� ���������� �� �������� �������������� �������������
        int scoldvalves; ///������ ������ ���������� ��������� ���������� ��������� ��� �����������.
        int no_acid_wash_max; ///������������ ���������� ���� ������� ��� �������.
        bool use_internal_medium_recipes; //���./����. ������������� �������� ��� ������ �������.

        i_DO_device* V00;
        i_DO_device* V01;
        i_DO_device* V02;
        i_DO_device* V03;
        i_DO_device* V04;
        i_DO_device* V05;
        i_DO_device* V06;
        i_DO_device* V07;
        i_DO_device* V08;
        i_DO_device* V09;
        i_DO_device* V10;
        i_DO_device* V11;
        i_DO_device* V12;
        i_DO_device* V13;

        i_DO_AO_device* NP;
        i_DO_AO_device* NK;
        i_DO_AO_device* NS;
        i_DI_device* LL;
        i_DI_device* LM;
        i_DI_device* LH;
        i_DI_device* LWL;
        i_DI_device* LWH;
        i_DI_device* LSL;
        i_DI_device* LSH;
        i_DI_device* LKL;
        i_DI_device* LKH;
        i_AI_device* TP;
        i_AI_device* TR;
        i_AI_device* Q;
        i_AO_device* ao;
        i_AO_device* PUMPFREQ;
        i_DI_device* FL;
        i_counter *cnt;
        timer* T[10];

        MSAPID* PIDP;
        MSAPID* PIDF;

        int msa_number; //����� �������
        char* ncar1; //����� ������
        char* ncar2; //����� ������
        char* ncar3; //����� ������
        char* ncar4; //����� ������
        int switch1;
        int switch2;
        int switch3;
        int switch4;
        saved_params_float      par_float;   ///< ����������� ���-��, ��� float.
        run_time_params_float   rt_par_float;///< ������� ���������, ��� float.
        float get_station_par(int parno);
        void set_station_par(int parno, float newval);
        float get_selfclean_par(int parno);
        void set_selfclean_par(int parno, float newval);

        int set_cmd( const char *prop, unsigned int idx, const char* val );
        int set_cmd( const char *prop, unsigned int idx, double val );

        void initline();
        int evaluate();

        float GetConc( int what );
        void SortRR( int where, int forcetotank);
        int SetRet(int val);
        int ForceRet(int val);
        int GetRetState();
        int HasRet();
        int timeIsOut();

        //������� ������ ��� ������ �� ���������������� �� LUA
        virtual int _DoStep(int step_to_do);
        virtual int _GoToStep(int cur, int param);
        virtual int _InitStep(int step_to_init, int not_first_call);
        virtual int _LoadProgram(void);
        virtual void _StopDev(void);
        virtual void _ResetLinesDevicesBeforeReset(void);
        virtual int _OporCIP(int where);
        virtual int _InitOporCIP(int where, int step_to_init, int not_first_call);
        virtual int _CheckErr(void);
        virtual int _Circ(int what);
        virtual int _InitCirc(int what, int step_to_init, int not_first_call);
        virtual int _InitToObject(int from, int where, int step_to_init, int f);
        virtual int _InitFromObject(int what, int where, int step_to_init, int f);
        virtual int _InitFilCirc(int with_what, int step_to_init, int f);
        virtual int _InitOporCirc(int where, int step_to_init, int not_first_call);
        virtual int _ToObject(int from, int where);
        virtual int _FromObject(int what, int where);
        virtual int _FillCirc(int with_what);
        virtual int _OporCirc(int where);
        virtual void _RT(void);
        virtual void _Stop(int step_to_stop);
        virtual int _InitDoseRR(int what, int step_to_init, int not_first_call);
        virtual int _DoseRR(int what);
    };
//---------------------------------------------------------------------------
rm_manager* G_RM_MANAGER();
//---------------------------------------------------------------------------
class rm_manager
    {
    public:
        /// <summary>
        /// ���������� ���������� PAC ��� ����������.
        /// </summary>
        /// <param name="name">��� ���������� PAC.</param>
        /// <param name="IP_address">IP-����� ���������� PAC.</param>
        /// <param name="remote_PAC_id">����������������� �����
        /// ���������� PAC.</param>
        ///
        /// <returns></returns>
        void add_rm_cmmctr( char* name, char* IP_address,
            int remote_PAC_id );
    };
//--------------------------------------------------------------------------
class modbus_client
    {
    protected:

    public:
        modbus_client(unsigned int id, char* ip, unsigned int port, unsigned long exchangetimeout);
        //���������� ������� ��������� modbus
        int read_discrete_inputs(unsigned int start_address, unsigned int quantity);
        int read_coils(unsigned int start_address, unsigned int quantity);
        int read_holding_registers(unsigned int address, unsigned int quantity);
        int read_input_registers(unsigned int address, unsigned int quantity);
        int write_coil(unsigned int address, unsigned char value);
        int force_multiply_coils(unsigned int address, unsigned int quantity);
        int write_multiply_registers(unsigned int address, unsigned int quantity);
        int async_read_discrete_inputs(unsigned int start_address, unsigned int quantity);
        int async_read_coils(unsigned int start_address, unsigned int quantity);
        int async_read_holding_registers(unsigned int address, unsigned int quantity);
        int async_read_input_registers(unsigned int address, unsigned int quantity);
        int async_write_coil(unsigned int address, unsigned char value);
        int async_force_multiply_coils(unsigned int address, unsigned int quantity);
        int async_write_multiply_registers(unsigned int address, unsigned int quantity);
        int async_read_write_multiply_registers(unsigned int readaddress, unsigned int readquantity, unsigned int wrireaddress, unsigned int writequantity);
        int async_mask_write_register(unsigned int writeaddress, unsigned int andmask, unsigned int ormask);
        int async_mask_write_register(unsigned int writeaddress);
        int get_async_result();
        void set_station(unsigned char new_station_id);
        //������� ��� ������ � ������� �� Lua
        void zero_output_buff(int startpos = 13);
        void set_byte(int address, unsigned char value);
        unsigned char get_byte(int address);
        void set_int2(unsigned int address, short value);
        short get_int2(unsigned int address);
        void set_int4(unsigned int address, int value);
        int get_int4(unsigned int address);
        void set_float(unsigned int address, float value);
        float get_float(unsigned int address);
        void set_bit(unsigned int address, int value);
        int get_bit(unsigned int address);
        int reg_get_bit(unsigned int reg, unsigned int offset);
        void reg_set_bit(unsigned int reg, unsigned int offset, int value);
        void mask_reset();
        void mask_set_bit(int pos, int value);
        unsigned char reverse(unsigned char b);
        int swapBits(int x, int p1, int p2, int n);
        int get_id();
    };
//-------------------------------------------------------------------------
class ModbusServ
    {
    public:
        static short int UnpackInt16( unsigned char* buf, int offset );
        static long int UnpackInt32( unsigned char* buf, int offset );
        static float UnpackFloat( unsigned char* Buf, int offset  );
        static unsigned int UnpackWord( unsigned char* Buf, int offset );
    };
//----------------------------------------------------------------------------
/// @brief ������ � Profibus Slave.
class profibus_slave
    {
    //���������������� �������.
    public:
        /// <summary>
        /// ��������� ������ ������.
        /// </summary>
        void activate();

        /// <summary>
        /// ��������� ������ �������.
        /// </summary>
        void set_station_address( int address );

        /// <summary>
        /// ��������� ������� ������� ������� ������.
        /// </summary>
        void set_output_byte_size( int size );

        /// <summary>
        /// ��������� ������� ������� ������� ������.
        /// </summary>
        void set_input_byte_size( int size );

    public:
        /// <summary>
        /// ��������� �������� ���� double.
        /// </summary>
        /// <param name="offset">��������, �������� 0..239.</param>
        virtual double get_double( int offset ) = 0;

        /// <summary>
        /// ��������� �������� ���� bool.
        /// </summary>
        /// <param name="byte_offset">��������, �������� 0..243.</param>
        /// <param name="bit_offset">��������, �������� 0..7.</param>
        virtual bool get_bool( int byte_offset, int bit_offset ) = 0;

        /// <summary>
        /// ��������� �������� ���� bool.
        /// </summary>
        /// <param name="byte_offset">��������, �������� 0..243.</param>
        /// <param name="bit_offset">��������, �������� 0..7.</param>
        /// <param name="val">��������.</param>
        virtual void set_bool( int byte_offset, int bit_offset, bool val ) = 0;

        /// <summary>
        /// ��������� �������� ���� int.
        /// </summary>
        /// <param name="byte_offset">��������, �������� 0..242.</param>
        virtual int get_int( int byte_offset ) = 0;

        /// <summary>
        /// ��������� �������� ���� int.
        /// </summary>
        /// <param name="byte_offset">��������, �������� 0..242.</param>
        /// <param name="val">��������.</param>
        virtual void set_int( int byte_offset, int val ) = 0;

        /// <summary>
        /// ��������� �������� ���� int (4 �����).
        /// </summary>
        /// <param name="byte_offset">��������, �������� 0..240.</param>
        virtual int get_int4( int byte_offset ) = 0;
    };

profibus_slave* G_PROFIBUS_SLAVE_LUA();
//-----------------------------------------------------------------------------
